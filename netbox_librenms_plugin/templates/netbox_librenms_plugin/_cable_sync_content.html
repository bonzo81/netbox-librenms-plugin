{% load helpers %}
{% include 'inc/messages.html' %}

<!-- Cable Sync Table -->
{% if cable_sync.table %}
<form method="post" action="{% url 'plugins:netbox_librenms_plugin:sync_device_cables' cable_sync.object.pk %}">
    {% csrf_token %}
    <div class="noprint d-flex justify-content-between align-items-center mt-3 mb-3">
        <div>
            <button type="submit" class="btn btn-primary">
                <span class="spinner spinner-border d-none" id="sync-spinner"></span>
                <span>Sync Selected Cables</span>
            </button>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col col-md-12">
            <div class="card">
                {% include 'inc/paginator.html' with paginator=cable_sync.table.paginator page=cable_sync.table.page %}
                {% include 'inc/table.html' with table=cable_sync.table %}
                {% include 'inc/paginator.html' with paginator=cable_sync.table.paginator page=cable_sync.table.page %}
            </div>
        </div>
    </div>
</form>
{% endif %}
<script>
function initializeCableSelect() {
    setTimeout(() => {
        const cableTable = document.getElementById('librenms-cable-table');
        if (!cableTable) return;
        
        const selects = cableTable.querySelectorAll('.form-select.tomselected');
        selects.forEach(select => {
            if (select.tomselect) {
                // Only initialize if not already initialized
                if (select.tomselect && !select.dataset.cableSelectInitialized) {
                    select.dataset.cableSelectInitialized = 'true';
                    select.tomselect.on('change', function(value) {
                        const deviceId = value;
                        const localPort = select.dataset.interface;
                        const rowId = select.dataset.rowId;

                        fetch('/plugins/librenms_plugin/verify-cable/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                            },
                            body: JSON.stringify({
                                device_id: deviceId,
                                local_port: localPort
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            const row = cableTable.querySelector(`tr[data-interface="${rowId}"]`);
                            if (data.status === 'success' && row) {
                                const portCell = row.querySelector('td[data-col="local_port"]');
                                portCell.innerHTML = data.local_port_url ? 
                                    `<a href="${data.local_port_url}">${data.local_port}</a>` : 
                                    data.local_port;
                            }
                        });
                    });
                }
            }
        });
    }, 100);
}
// Initialize scripts on initial DOM load
document.addEventListener('DOMContentLoaded', function () {
    initializeCableSelect();
});

// Initialize scripts after HTMX swaps content
document.body.addEventListener('htmx:afterSwap', function (event) {
    initializeCableSelect();
});

</script>