{% load helpers %}
{% include 'inc/messages.html' %}

<!-- Interface Sync Table -->
{% if interface_sync.table %}

{% with model_name=interface_sync.object|meta:"model_name" %}
<form method="post"
    action="{% url 'plugins:netbox_librenms_plugin:sync_selected_interfaces' object_type=model_name object_id=interface_sync.object.pk %}">
    {% endwith %}
    {% csrf_token %}
    {% block table_actions %}
    <div class="noprint d-flex justify-content-between align-items-center mt-3 mb-3">
        <div>
            <button type="submit" class="btn btn-primary">
                <span class="spinner spinner-border d-none" id="sync-spinner"></span>
                <span>Sync Selected Interfaces</span>
            </button>
            <a href="#" class="m-2" data-bs-toggle="modal" data-bs-target="#interfaceTypeHelpModal">
                <i class="mdi mdi-help-circle"></i> info
            </a>
        </div>

        <div class="d-flex align-items-center">
            {% if interface_sync.cache_expiry %}
            <div id="cache-countdown" class="me-3">
                Cache expires in: <span id="countdown-timer"
                    data-expiry="{{ interface_sync.cache_expiry|date:'c' }}"></span>
            </div>
            <script>
                function initializeCountdown() {
                    function updateCountdown() {
                        const countdownElement = document.getElementById("countdown-timer");
                        const expiry = new Date(countdownElement.dataset.expiry).getTime();
                        const now = new Date().getTime();
                        const distance = expiry - now;

                        if (distance < 0) {
                            clearInterval(countdownInterval);
                            countdownElement.innerHTML = "EXPIRED";
                            return;
                        }

                        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                        countdownElement.innerHTML = minutes + "m " + seconds + "s ";
                    }

                    // Clear any existing interval
                    if (window.countdownInterval) {
                        clearInterval(window.countdownInterval);
                    }

                    // Start a new interval
                    updateCountdown();
                    window.countdownInterval = setInterval(updateCountdown, 1000);
                }

                // Initial call
                initializeCountdown();
            </script>
            {% endif %}
            <div class="color-key me-3">
                <span class="badge text-success text-white">Matching values</span>
                <span class="badge text-warning text-white">Mismatched values</span>
                <span class="badge text-danger text-white">Not present in NetBox</span>
            </div>
        </div>
    </div>
    {% endblock %} <!-- End block table_actions -->


    <div class="row mb-3">
        <div class="col col-md-12">
            <button class="btn btn-sm btn-secondary mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#filterSection" aria-expanded="false" aria-controls="filterSection">
                <i class="mdi mdi-filter"></i> Toggle Filters
            </button>
            <div class="collapse mb-3" id="filterSection">
                <div class="mb-2">
                    <small class="text-muted">
                        <i class="mdi mdi-information"></i> Filters apply to currently displayed interfaces. Adjust the "per page" setting to apply the filters to more interfaces.
                    </small>
                </div>
                <div class="filter-container d-flex gap-2">
                    <input type="text" id="filter-name" placeholder="Filter by Name" class="form-control">
                    <input type="text" id="filter-type" placeholder="Filter by Type" class="form-control">
                    <input type="text" id="filter-speed" placeholder="Filter by Speed" class="form-control">
                    <input type="text" id="filter-mac" placeholder="Filter by MAC" class="form-control">
                    <input type="text" id="filter-mtu" placeholder="Filter by MTU" class="form-control">
                    <input type="text" id="filter-enabled" placeholder="Filter by Status" class="form-control">
                    <input type="text" id="filter-description" placeholder="Filter by Description" class="form-control">
                </div>

            </div>
            <div class="card">
                {% include 'inc/paginator.html' with paginator=interface_sync.table.paginator page=interface_sync.table.page %}
                {% include 'inc/table.html' with table=interface_sync.table %}
                {% include 'inc/paginator.html' with paginator=interface_sync.table.paginator page=interface_sync.table.page %}
            </div>
        </div>
    </div>
</form>
{% endif %} <!-- End if interface_sync.table -->

<!-- Interface Type Help Modal -->
<div class="modal fade" id="interfaceTypeHelpModal" tabindex="-1" aria-labelledby="interfaceTypeHelpModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="interfaceTypeHelpModalLabel">NetBox Interface Sync Info</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h5>Interface Type mapping</h5>
                <p>Interface type mappings control how LibreNMS interface types are translated to NetBox interface types
                    during synchronization. These mappings can be customized in the plugin settings menu. The icons in
                    the interface list indicate the mapping status for each interface type:</p>
                <ul>
                    <li><i class="mdi mdi-link-variant"></i> - A mapping is configured for this interface type</li>
                    <li><i class="mdi mdi-link-variant-off"></i> - No mapping is currently set for this interface type
                    </li>
                </ul>
                <h5>Virtual Chassis Member Selection</h5>
                <p>For devices that are part of a virtual chassis, the plugin will attempt to select the correct virutal
                    chassis member by matching the first number in the interface name to the device position in the
                    virutal chassis. The selected device can be changed in the table before sync the interface.</p>
                <p>When changing the selected device for an interface row, the data will be checked again against the
                    newly selected device.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<script>
    <!-- Interface Sync Table JavaScript -->
    // Function to initialize interface synchronization (checkboxes)
    function initializeInterfaceSync() {
        const toggleAll = document.querySelector('th input.toggle');
        const checkboxes = document.querySelectorAll('td input[name="select"]');
        let lastChecked = null;

        if (toggleAll) {
            toggleAll.addEventListener('change', function () {
                checkboxes.forEach(checkbox => {
                    checkbox.checked = toggleAll.checked;
                });
            });
        }

        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('click', function (e) {
                if (!lastChecked) {
                    lastChecked = checkbox;
                    return;
                }

                if (e.shiftKey) {
                    const start = Array.from(checkboxes).indexOf(checkbox);
                    const end = Array.from(checkboxes).indexOf(lastChecked);
                    Array.from(checkboxes).slice(Math.min(start, end), Math.max(start, end) + 1).forEach(cb => {
                        cb.checked = lastChecked.checked;
                    });
                }

                lastChecked = checkbox;
            });
        });
    }

    // Function to initialize TomSelect elements for interface selection
    function initializeTomSelect() {
        // Small delay to ensure TomSelect is fully initialized in the DOM before attaching event listeners
        setTimeout(() => {
            const selects = document.querySelectorAll('.form-select.tomselected');

            selects.forEach(select => {
                if (select.tomselect) {

                    select.tomselect.on('change', function (value) {
                        const deviceId = value;
                        const interfaceName = select.dataset.interface;
                        const rowId = select.dataset.rowId;

                        fetch('/plugins/librenms_plugin/verify-interface/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                            },
                            body: JSON.stringify({
                                device_id: deviceId,
                                interface_name: interfaceName
                            })
                        })
                            .then(response => {
                                return response.json();
                            })
                            .then(data => {
                                const row = document.querySelector(`tr[data-interface="${rowId}"]`);


                                if (data.status === 'success' && row) {
                                    const formattedRow = data.formatted_row;
                                    row.querySelector('td[data-col="name"]').innerHTML = formattedRow.name;
                                    row.querySelector('td[data-col="type"]').innerHTML = formattedRow.type;
                                    row.querySelector('td[data-col="speed"]').innerHTML = formattedRow.speed;
                                    row.querySelector('td[data-col="mac_address"]').innerHTML = formattedRow.mac_address;
                                    row.querySelector('td[data-col="mtu"]').innerHTML = formattedRow.mtu;
                                    row.querySelector('td[data-col="enabled"]').innerHTML = formattedRow.enabled;
                                    row.querySelector('td[data-col="description"]').innerHTML = formattedRow.description;
                                }
                            });
                    });
                }
            });
        }, 50);
    }

// Add event listeners for all filter inputs
['name', 'type', 'speed', 'mac', 'mtu', 'enabled', 'description'].forEach(filter => {
    console.log(`Setting up listener for filter-${filter}`);
    document.getElementById(`filter-${filter}`).addEventListener('input', filterTable);
});

function filterTable() {
    console.log('Filter function called');
    
    const filters = {
        name: document.getElementById('filter-name').value.toLowerCase(),
        type: document.getElementById('filter-type').value.toLowerCase(),
        speed: document.getElementById('filter-speed').value.toLowerCase(),
        mac: document.getElementById('filter-mac').value.toLowerCase(),
        mtu: document.getElementById('filter-mtu').value.toLowerCase(),
        enabled: document.getElementById('filter-enabled').value.toLowerCase(),
        description: document.getElementById('filter-description').value.toLowerCase()
    };
    console.log('Filter values:', filters);

    const rows = document.querySelectorAll('tr[data-interface]');
    console.log('Found rows:', rows.length);

    rows.forEach(row => {
        console.log('Processing row:', row.getAttribute('data-interface'));
        const matches = {
            name: (row.querySelector('td[data-col="name"] span')?.textContent || row.querySelector('td[data-col="name"]').textContent).toLowerCase().includes(filters.name),
            type: (row.querySelector('td[data-col="type"] span')?.textContent || row.querySelector('td[data-col="type"]').textContent).toLowerCase().includes(filters.type),
            speed: (row.querySelector('td[data-col="speed"] span')?.textContent || row.querySelector('td[data-col="speed"]').textContent).toLowerCase().includes(filters.speed),
            mac: (row.querySelector('td[data-col="mac_address"] span')?.textContent || row.querySelector('td[data-col="mac_address"]').textContent).toLowerCase().includes(filters.mac),
            mtu: (row.querySelector('td[data-col="mtu"] span')?.textContent || row.querySelector('td[data-col="mtu"]').textContent).toLowerCase().includes(filters.mtu),
            enabled: (row.querySelector('td[data-col="enabled"] span')?.textContent || row.querySelector('td[data-col="enabled"]').textContent).toLowerCase().includes(filters.enabled),
            description: (row.querySelector('td[data-col="description"] span')?.textContent || row.querySelector('td[data-col="description"]').textContent).toLowerCase().includes(filters.description)
        };
        console.log('Match results:', matches);

        row.style.display = Object.values(matches).every(match => match) ? '' : 'none';
    });
}





    // Function to initialize all necessary scripts
    function initializeScripts() {
        initializeInterfaceSync();
        initializeTomSelect();
    }

    // Initialize scripts on initial DOM load
    document.addEventListener('DOMContentLoaded', function () {
        initializeScripts();

    });

    // Initialize scripts after HTMX swaps content
    document.body.addEventListener('htmx:afterSwap', function (event) {
        initializeScripts();
    });



</script>