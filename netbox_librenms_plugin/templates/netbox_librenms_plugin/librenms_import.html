{% extends 'generic/_base.html' %}
{% load buttons %}
{% load helpers %}
{% load plugins %}
{% load render_table from django_tables2 %}
{% load static %}
{% load i18n %}

{% block title %}{{ title }}{% endblock %}

{% block extra_styles %}
<style>
    /* Ensure dropdowns can overflow the table container */
    .card, #object_list {
        overflow: visible !important;
    }
</style>
{% endblock %}

{% block controls %}
  <div class="btn-list">
    {% plugin_list_buttons model %}
    {% action_buttons actions model %}
  </div>
{% endblock controls %}

{% block content %}

  {# Display Django messages #}
  {% include 'inc/messages.html' %}

  {# Collapsible Filter Section #}
  {% if filter_form %}
    <div class="card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
          Search Filters
          {% if filter_form.changed_data %}
            {% badge filter_form.changed_data|length bg_color="primary" %}
          {% endif %}
        </h5>
        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#filter-collapse" aria-expanded="{% if filter_form.changed_data %}false{% else %}true{% endif %}" aria-controls="filter-collapse">
          <i class="mdi mdi-filter"></i> Toggle Filters
        </button>
      </div>
      <div class="collapse {% if not filter_form.changed_data %}show{% endif %}" id="filter-collapse">
        <div class="card-body">
          <div class="row">
            {# Instructions column #}
            <div class="col-md-4">
              <h6 class="mb-2"><i class="mdi mdi-information-outline"></i> Filter Requirements</h6>
              <p class="mb-3"><strong>At least one filter is required</strong> to search LibreNMS devices.</p>

              <p class="mb-1"><strong>Filter Types:</strong></p>
              <ul class="mb-3" style="padding-left: 1.2rem; font-size: 0.9rem;">
                  <li><strong>Location/Type/OS:</strong> Exact match</li>
                  <li><strong>Hostname:</strong> Partial match</li>
                  <li><strong>System Name:</strong> Exact match (partial when combined)</li>
              </ul>

              <p class="mb-0 text-muted small">
                  <i class="mdi mdi-lightbulb-on-outline"></i> Start with Location or Type, then refine with Hostname or System Name.
              </p>
              <div class="alert alert-info small mt-3 mb-0" role="status">
                <strong>Cache tip:</strong> Search results are cached for 5 minutes to speed up repeat lookups. Initial searches against large LibreNMS datasets can take a while, but you can force a refresh using the "Clear cache before search" option below.
              </div>
            </div>
            {# Filters column #}
            <div class="col-md-8">
              <form method="get" class="form" id="librenms-import-filter-form">
                <input type="hidden" name="apply_filters" value="1">
                <!-- Filter submission with proper cancellation support -->
                <script>
    // AbortController for cancelling the filter request
    let currentAbortController = null;

    document.getElementById('librenms-import-filter-form').addEventListener('submit', function(e) {
      e.preventDefault();

      // Cancel any existing request before starting a new one
      if (currentAbortController) {
        currentAbortController.abort();
        currentAbortController = null;
      }

      // Create new AbortController for this request
      currentAbortController = new AbortController();

      // Show filter processing modal
      const filterModal = document.getElementById('filter-processing-modal');
      let modalInstance;

      if (filterModal) {
        if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
          modalInstance = new bootstrap.Modal(filterModal);
          modalInstance.show();
        } else {
          // Fallback for manual modal display
          filterModal.classList.add('show');
          filterModal.style.display = 'block';
          filterModal.setAttribute('aria-modal', 'true');
          filterModal.removeAttribute('aria-hidden');
          document.body.classList.add('modal-open');

          // Add backdrop
          const backdrop = document.createElement('div');
          backdrop.className = 'modal-backdrop fade show';
          backdrop.id = 'filter-modal-backdrop';
          document.body.appendChild(backdrop);
        }
      }

      // Handle cancel button - actually abort the request
      const cancelBtn = document.getElementById('cancel-filter-btn');
      if (cancelBtn) {
        cancelBtn.onclick = function() {
          // Abort the fetch request
          if (currentAbortController) {
            currentAbortController.abort();
            currentAbortController = null;
          }

          // Hide modal
          if (modalInstance) {
            modalInstance.hide();
          } else {
            // Fallback manual hide
            filterModal.classList.remove('show');
            filterModal.style.display = 'none';
            filterModal.removeAttribute('aria-modal');
            filterModal.setAttribute('aria-hidden', 'true');
            document.body.classList.remove('modal-open');
            const backdrop = document.getElementById('filter-modal-backdrop');
            if (backdrop) {
              backdrop.remove();
            }
          }
        };
      }

      // Build completely clean URL parameters from current form state only
      const params = new URLSearchParams();
      // Add all text/select fields with non-empty values
      const inputs = this.querySelectorAll('input:not([type="checkbox"]), select');
      inputs.forEach(input => {
        if (input.name && input.value) {
          params.append(input.name, input.value);
        }
      });

      // Explicitly add ONLY currently checked checkboxes
      const checkboxes = ['id_enable_vc_detection', 'id_clear_cache', 'id_show_disabled'];
      checkboxes.forEach(id => {
        const checkbox = document.getElementById(id);
        if (checkbox?.checked && checkbox.name) {
          params.set(checkbox.name, 'on');
        }
      });

      // Strip any existing query parameters from the action URL
      const baseUrl = this.action.split('?')[0];

      // Build final URL
      const finalUrl = baseUrl + '?' + params.toString();
      console.log('Fetching filtered results:', finalUrl);

      // Use fetch with AbortController instead of window.location
      fetch(finalUrl, {
        method: 'GET',
        signal: currentAbortController.signal,
        headers: {
          'Accept': 'text/html'
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.text();
      })
      .then(html => {
        // Replace the entire page content with the returned HTML
        document.open();
        document.write(html);
        document.close();
        currentAbortController = null;
      })
      .catch(error => {
        if (error.name === 'AbortError') {
          console.log('Filter request was cancelled by user');
        } else {
          console.error('Error fetching filtered results:', error);
          alert('Error loading filtered results. Please try again.');
        }
        
        // Hide modal on error
        if (modalInstance) {
          modalInstance.hide();
        } else {
          filterModal.classList.remove('show');
          filterModal.style.display = 'none';
          document.body.classList.remove('modal-open');
          const backdrop = document.getElementById('filter-modal-backdrop');
          if (backdrop) {
            backdrop.remove();
          }
        }
        currentAbortController = null;
      });
    });
</script>
                {% if show_filter_warning %}
                  <div class="alert alert-warning alert-dismissible fade show border-warning" role="alert" style="border-left: 4px solid #ffc107;">
                    <i class="mdi mdi-alert text-warning"></i>
                    <strong>Filter Required:</strong> {{ filter_warning }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                  </div>
                {% endif %}
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="{{ filter_form.librenms_location.id_for_label }}" class="form-label">{{ filter_form.librenms_location.label }}</label>
                    {{ filter_form.librenms_location }}
                  </div>
                  <div class="col-md-6">
                    <label for="{{ filter_form.librenms_type.id_for_label }}" class="form-label">{{ filter_form.librenms_type.label }}</label>
                    {{ filter_form.librenms_type }}
                  </div>
                </div>
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="{{ filter_form.librenms_os.id_for_label }}" class="form-label">{{ filter_form.librenms_os.label }}</label>
                    {{ filter_form.librenms_os }}
                    {% if filter_form.librenms_os.help_text %}
                      <small class="form-text text-muted">{{ filter_form.librenms_os.help_text }}</small>
                    {% endif %}
                  </div>
                  <div class="col-md-6">
                    <label for="{{ filter_form.librenms_hostname.id_for_label }}" class="form-label">{{ filter_form.librenms_hostname.label }}</label>
                    {{ filter_form.librenms_hostname }}
                    {% if filter_form.librenms_hostname.help_text %}
                      <small class="form-text text-muted">{{ filter_form.librenms_hostname.help_text }}</small>
                    {% endif %}
                  </div>
                </div>
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="{{ filter_form.librenms_sysname.id_for_label }}" class="form-label">{{ filter_form.librenms_sysname.label }}</label>
                    {{ filter_form.librenms_sysname }}
                    {% if filter_form.librenms_sysname.help_text %}
                      <small class="form-text text-muted">{{ filter_form.librenms_sysname.help_text }}</small>
                    {% endif %}
                  </div>
                  <div class="col-md-6">
                    <label for="{{ filter_form.validation_status.id_for_label }}" class="form-label">{{ filter_form.validation_status.label }}</label>
                    {{ filter_form.validation_status }}
                    {% if filter_form.validation_status.help_text %}
                      <small class="form-text text-muted">{{ filter_form.validation_status.help_text }}</small>
                    {% endif %}
                  </div>
                </div>
                <div class="row mb-3">
                  <div class="col-md-12">
                    <div class="form-check">
                      {{ filter_form.show_disabled }}
                      <label class="form-check-label" for="{{ filter_form.show_disabled.id_for_label }}">
                        {{ filter_form.show_disabled.label }}
                      </label>
                      {% if filter_form.show_disabled.help_text %}
                        <small class="form-text text-muted d-block">{{ filter_form.show_disabled.help_text }}</small>
                      {% endif %}
                    </div>
                    <div class="form-check mt-2">
                      {{ filter_form.enable_vc_detection }}
                      <label class="form-check-label" for="{{ filter_form.enable_vc_detection.id_for_label }}">
                        {{ filter_form.enable_vc_detection.label }}
                      </label>
                      {% if filter_form.enable_vc_detection.help_text %}
                        <small class="form-text text-muted d-block">{{ filter_form.enable_vc_detection.help_text }}</small>
                      {% endif %}
                    </div>
                    <div class="form-check mt-2">
                      {{ filter_form.clear_cache }}
                      <label class="form-check-label" for="{{ filter_form.clear_cache.id_for_label }}">
                        {{ filter_form.clear_cache.label }}
                      </label>
                      {% if filter_form.clear_cache.help_text %}
                        <small class="form-text text-muted d-block">{{ filter_form.clear_cache.help_text }}</small>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <div class="text-end">
                  <button type="submit" class="btn btn-primary">
                    <i class="mdi mdi-filter"></i> Apply Filters
                  </button>
                  <a href="{% url 'plugins:netbox_librenms_plugin:librenms_import' %}" class="btn btn-secondary">
                    <i class="mdi mdi-close"></i> Clear
                  </a>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  {# Applied filters #}
  {% if filter_form %}
    {% applied_filters model filter_form request.GET %}
  {% endif %}

  {# Results Section #}
  {% if table.page.paginator.count == 0 %}
    <div class="alert alert-warning mb-3">
        <h6 class="alert-heading">
            <i class="mdi mdi-alert"></i> No Results Found
        </h6>
        <p class="mb-0">
            No devices found matching your filters. Try adjusting your search criteria above.
        </p>
    </div>
  {% else %}
    {# Import Settings #}
    <div class="card mb-3 border-primary">
        <div class="card-body p-2">
            <div class="d-flex align-items-center gap-3">
                <strong class="me-2">Import Settings:</strong>
                <div class="form-check form-switch mb-0">
                    <input class="form-check-input" type="checkbox" id="use-sysname-toggle" name="use-sysname-toggle" {% if settings.use_sysname_default %}checked{% endif %}
                           data-bs-toggle="tooltip"
                           title="Use SNMP sysName instead of LibreNMS hostname">
                    <label class="form-check-label small" for="use-sysname-toggle">
                        Use sysName
                    </label>
                </div>
                <div class="form-check form-switch mb-0">
                    <input class="form-check-input" type="checkbox" id="strip-domain-toggle" name="strip-domain-toggle" {% if settings.strip_domain_default %}checked{% endif %}
                           data-bs-toggle="tooltip"
                           title="Remove domain suffix (e.g., 'switch01.example.com' â†’ 'switch01'). IP addresses preserved.">
                    <label class="form-check-label small" for="strip-domain-toggle">
                        Strip domain
                    </label>
                </div>
            </div>
        </div>
    </div>

    {% if vc_detection_skipped %}
      <div class="alert alert-info mb-3">
        <i class="mdi mdi-progress-clock"></i>
        Virtual chassis detection is disabled for this search (default). Selecting a role from the drop down will trigger a virtual chassis check for that device.
      </div>
    {% endif %}
    {% if cache_cleared %}
      <div class="alert alert-success mb-3">
        <i class="mdi mdi-refresh"></i>
        Cache cleared before this search. Results were pulled directly from LibreNMS and will be cached again for 5 minutes.
      </div>
    {% endif %}

    {# Bulk import toolbar #}
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
      <div class="d-flex align-items-center gap-2 flex-wrap">
        <button type="button" class="btn btn-outline-primary" id="select-all-ready">
                <i class="mdi mdi-checkbox-multiple-marked"></i> Select All Ready
            </button>
            <button type="button" class="btn btn-outline-secondary" id="select-none">
                <i class="mdi mdi-checkbox-multiple-blank-outline"></i> Deselect All
            </button>
            <span class="text-muted" id="selection-count">
                <i class="mdi mdi-information"></i> 0 devices selected
            </span>
        </div>
      <button type="button" class="btn btn-success" id="bulk-import-btn" disabled
          hx-post="{% url 'plugins:netbox_librenms_plugin:bulk_import_confirm' %}"
          hx-target="#htmx-modal-content"
          hx-swap="innerHTML"
          hx-include="#import-selection-form, #use-sysname-toggle, #strip-domain-toggle">
        <span class="d-inline-flex align-items-center gap-1">
          <i class="mdi mdi-download"></i>
          <span>Import Selected (<span id="import-count">0</span>)</span>
        </span>
        <span class="spinner-border spinner-border-sm ms-2 htmx-indicator" role="status" aria-hidden="true" style="display: none;"></span>
      </button>
    </div>
  {% endif %}

    <form method="post" class="form form-horizontal" id="import-selection-form">
    {% csrf_token %}
    <input type="hidden" name="return_url" value="{% if return_url %}{{ return_url }}{% else %}{{ request.path }}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}{% endif %}" />

    {# Objects table #}
    <div class="card">
      <div class="htmx-container" id="object_list"
           hx-trigger="deviceImported from:body"
           hx-get="{{ request.path }}?{{ request.GET.urlencode }}"
           hx-select="#object_list"
           hx-swap="outerHTML">
        {% include 'inc/paginator.html' with htmx=True table=table paginator=table.paginator page=table.page %}
        {% include 'inc/table.html' %}
        {% include 'inc/paginator.html' with htmx=True table=table paginator=table.paginator page=table.page %}
      </div>
    </div>
    {# /Objects table #}

  </form>

  {# JavaScript for import functionality #}
  <script>
  // Configure HTMX to include CSRF token in all requests
  document.body.addEventListener('htmx:configRequest', function(event) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
      event.detail.headers['X-CSRFToken'] = csrfToken.value;
    }
  });

  document.addEventListener('DOMContentLoaded', function() {
    const modalElement = document.getElementById('htmx-modal');
    const modalContent = document.getElementById('htmx-modal-content');
    let fallbackBackdrop = null;

    // Initialize Bootstrap tooltips
    if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
      [...tooltipTriggerList].map(el => new bootstrap.Tooltip(el));
    }

    function showModal() {
      if (!modalElement) {
        return;
      }

      if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
        let instance = bootstrap.Modal.getInstance?.(modalElement) || null;
        if (!instance) {
          instance = new bootstrap.Modal(modalElement);
        }
        instance.show();
        return;
      }

      if (typeof window.bootstrap !== 'undefined' && window.bootstrap.Modal) {
        let instance = window.bootstrap.Modal.getInstance?.(modalElement) || null;
        if (!instance) {
          instance = new window.bootstrap.Modal(modalElement);
        }
        instance.show();
        return;
      }

      if (typeof $ !== 'undefined' && typeof $(modalElement).modal === 'function') {
        $(modalElement).modal('show');
        return;
      }

      if (!modalElement.classList.contains('show')) {
        modalElement.classList.add('show');
        modalElement.style.display = 'block';
        modalElement.removeAttribute('aria-hidden');
        modalElement.setAttribute('aria-modal', 'true');
      }

      if (!document.body.classList.contains('modal-open')) {
        document.body.classList.add('modal-open');
      }

      if (!document.querySelector('.modal-backdrop')) {
        fallbackBackdrop = document.createElement('div');
        fallbackBackdrop.className = 'modal-backdrop fade show';
        document.body.appendChild(fallbackBackdrop);
      }
    }

    function hideModal() {
      if (!modalElement) {
        return;
      }

      if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
        const instance = bootstrap.Modal.getInstance?.(modalElement);
        if (instance) {
          instance.hide();
          return;
        }
      }

      if (typeof window.bootstrap !== 'undefined' && window.bootstrap.Modal) {
        const instance = window.bootstrap.Modal.getInstance?.(modalElement);
        if (instance) {
          instance.hide();
          return;
        }
      }

      if (typeof $ !== 'undefined' && typeof $(modalElement).modal === 'function') {
        $(modalElement).modal('hide');
        return;
      }

      modalElement.classList.remove('show');
      modalElement.style.display = '';
      modalElement.setAttribute('aria-hidden', 'true');
      modalElement.removeAttribute('aria-modal');
      document.body.classList.remove('modal-open');

      if (fallbackBackdrop) {
        fallbackBackdrop.remove();
        fallbackBackdrop = null;
      } else {
        const backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) {
          backdrop.remove();
        }
      }
    }

    function ensureModalVisible(event) {
      if (!modalElement || event.detail.target.id !== 'htmx-modal-content') {
        return;
      }

      if (modalContent && modalContent.innerHTML.trim().length === 0 && event.detail.xhr) {
        modalContent.innerHTML = event.detail.xhr.responseText;
      }

      showModal();
    }

    document.body.addEventListener('htmx:afterSwap', ensureModalVisible);

    document.body.addEventListener('click', function(event) {
      if (!modalElement) {
        return;
      }

      const dismissTrigger = event.target.closest('[data-bs-dismiss="modal"]');
      if (dismissTrigger) {
        event.preventDefault();

        // Check if it's in the HTMX modal
        if (modalElement.contains(dismissTrigger)) {
          hideModal();
        }
      }
    });

    // Handle backdrop clicks for HTMX modal
    modalElement?.addEventListener('click', function(event) {
      if (event.target === modalElement) {
        hideModal();
      }
    });

    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        if (modalElement?.classList.contains('show')) {
          hideModal();
        }
      }
    });

    // Listen for HTMX closeModal trigger to close the modal programmatically
    document.body.addEventListener('closeModal', function() {
      hideModal();
    });

    const bulkImportBtn = document.getElementById('bulk-import-btn');
    const selectionCount = document.getElementById('selection-count');
    const importCount = document.getElementById('import-count');
    let pendingRowImport = null;

    function getCheckboxes() {
      return document.querySelectorAll('input[name="select"]');
    }

    function captureSelectionState() {
      return Array.from(getCheckboxes()).map(cb => ({
        value: cb.value,
        checked: cb.checked,
      }));
    }

    function restoreSelectionState(state) {
      if (!state) {
        return;
      }
      const checkboxes = getCheckboxes();
      state.forEach(saved => {
        const checkbox = Array.from(checkboxes).find(cb => cb.value === saved.value);
        if (checkbox) {
          checkbox.checked = saved.checked;
        }
      });
      updateSelectionDisplay();
    }

    function updateSelectionDisplay() {
      if (!bulkImportBtn || !selectionCount || !importCount) {
        return;
      }

      const checkboxes = getCheckboxes();
      const selected = Array.from(checkboxes).filter(cb => cb.checked);
      const count = selected.length;

      selectionCount.innerHTML = `<i class="mdi mdi-information"></i> ${count} device${count !== 1 ? 's' : ''} selected`;
      importCount.textContent = count;
      bulkImportBtn.disabled = count === 0;
    }

    updateSelectionDisplay();

    const selectAllReadyBtn = document.getElementById('select-all-ready');
    if (selectAllReadyBtn) {
      selectAllReadyBtn.addEventListener('click', function() {
        const checkboxes = getCheckboxes();
        checkboxes.forEach(cb => {
          // Select checkboxes for rows that have a ready-to-import button (device-ready class)
          if (!cb.disabled && cb.closest('tr')?.querySelector('.device-ready')) {
            cb.checked = true;
          }
        });
        updateSelectionDisplay();
      });
    }

    const selectNoneBtn = document.getElementById('select-none');
    if (selectNoneBtn) {
      selectNoneBtn.addEventListener('click', function() {
        const checkboxes = getCheckboxes();
        checkboxes.forEach(cb => {
          cb.checked = false;
        });
        updateSelectionDisplay();
      });
    }

    // Use event delegation for checkbox changes since they can be dynamically added
    document.body.addEventListener('change', function(event) {
      if (event.target.matches('input[name="select"]')) {
        updateSelectionDisplay();
      }
    });

    document.body.addEventListener('click', function(event) {
      const rowButton = event.target.closest('.device-import-btn.device-ready');
      if (!rowButton || rowButton.disabled) {
        return;
      }

      if (!bulkImportBtn || pendingRowImport) {
        return;
      }

      const deviceId = rowButton.dataset.deviceId;
      if (!deviceId) {
        return;
      }

      event.preventDefault();

      const previousSelections = captureSelectionState();
      pendingRowImport = { previousSelections };

      const checkboxes = getCheckboxes();
      checkboxes.forEach(cb => {
        cb.checked = false;
      });

      const targetCheckbox = Array.from(checkboxes).find(cb => cb.value === deviceId);
      if (!targetCheckbox) {
        restoreSelectionState(previousSelections);
        pendingRowImport = null;
        console.warn('Unable to locate selection checkbox for device', deviceId);
        return;
      }

      targetCheckbox.checked = true;
      updateSelectionDisplay();

      bulkImportBtn.click();
    });

    document.body.addEventListener('htmx:afterSwap', function(event) {
      if (event.detail.target.tagName === 'TR') {
        updateSelectionDisplay();
      }

      if (event.detail.target.id === 'import-results-modal-content') {
        const failedCount = event.detail.target.querySelector('[data-failed-count]');
        if (failedCount && failedCount.dataset.failedCount === '0') {
          setTimeout(() => {
            const resultsModal = document.getElementById('import-results-modal');
            if (resultsModal && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
              const modalInstance = bootstrap.Modal.getInstance(resultsModal);
              if (modalInstance) {
                modalInstance.hide();
              }
            }
            window.location.reload();
          }, 3000);
        }
      }
    });

    document.body.addEventListener('htmx:afterRequest', function(event) {
      if (event.target === bulkImportBtn && pendingRowImport) {
        restoreSelectionState(pendingRowImport.previousSelections);
        pendingRowImport = null;
      }
    });

    document.body.addEventListener('htmx:responseError', function(event) {
      if (event.target === bulkImportBtn && pendingRowImport) {
        restoreSelectionState(pendingRowImport.previousSelections);
        pendingRowImport = null;
      }
    });

    const currentUrl = window.location.href;
    const lastUrl = sessionStorage.getItem('last_import_url');

    if (currentUrl !== lastUrl) {
      Object.keys(sessionStorage).forEach(key => {
        if (key.startsWith('device_role_')) {
          sessionStorage.removeItem(key);
        }
      });
    }

    sessionStorage.setItem('last_import_url', currentUrl);

  });
  </script>

    {# HTMX Modal for import actions #}
  <div class="modal fade" id="htmx-modal" tabindex="-1" aria-labelledby="htmxModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content" id="htmx-modal-content">
        {# Content loaded via HTMX #}
        <div class="modal-body text-center">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  {# Filter Processing Modal #}
  <div class="modal fade" id="filter-processing-modal" tabindex="-1" aria-labelledby="filterProcessingLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body text-center py-4">
          <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <h5 class="mb-2">Applying Filters</h5>
          <p class="text-muted mb-3">Fetching LibreNMS data and processing filters...</p>
          <button type="button" class="btn btn-secondary btn-sm" id="cancel-filter-btn">
            <i class="mdi mdi-close"></i> Cancel
          </button>
        </div>
      </div>
    </div>
  </div>

{% endblock %}

