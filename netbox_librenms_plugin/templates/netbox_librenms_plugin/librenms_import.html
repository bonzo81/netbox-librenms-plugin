{% extends 'generic/_base.html' %}
{% load buttons %}
{% load helpers %}
{% load plugins %}
{% load render_table from django_tables2 %}
{% load static %}
{% load i18n %}

{% block title %}{{ title }}{% endblock %}

{% block extra_styles %}
<style>
    /* Ensure dropdowns can overflow the table container */
    .card, #object_list {
        overflow: visible !important;
    }
</style>
{% endblock %}

{% block controls %}
  <div class="btn-list">
    {% plugin_list_buttons model %}
    {% action_buttons actions model %}
  </div>
{% endblock controls %}

{% block content %}

  {# Collapsible Filter Section #}
  {% if filter_form %}
    <div class="card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
          Search Filters
          {% if filter_form.changed_data %}
            {% badge filter_form.changed_data|length bg_color="primary" %}
          {% endif %}
        </h5>
        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#filter-collapse" aria-expanded="{% if filter_form.changed_data %}false{% else %}true{% endif %}" aria-controls="filter-collapse">
          <i class="mdi mdi-filter"></i> Toggle Filters
        </button>
      </div>
      <div class="collapse {% if not filter_form.changed_data %}show{% endif %}" id="filter-collapse">
        <div class="card-body">
          <div class="row">
            {# Instructions column #}
            <div class="col-md-4">
              <h6><i class="mdi mdi-information-outline"></i> Quick Guide</h6>
              <p class="mb-2">Search for devices in LibreNMS and import them into NetBox. At least one filter is required to begin your search.</p>

              <p class="mb-1"><strong>How Filters Work:</strong></p>
              <ul class="mb-2" style="padding-left: 1.2rem;">
                  <li><strong>Location/Type/OS:</strong> Exact match using LibreNMS API</li>
                  <li><strong>Hostname:</strong> Partial match when used alone or combined with other filters</li>
                  <li><strong>System Name:</strong> Exact match when used alone; partial match when combined with other filters</li>
              </ul>

              <p class="mb-1"><strong>LibreNMS API Limitations:</strong></p>
              <p class="mb-2">The LibreNMS API only supports one filter type per request. When you combine multiple filters, a single filter queries the API and additional filters are applied client-side for more specific results.</p>

              <p class="mb-0 text-muted">
                  <i class="mdi mdi-lightbulb-on-outline"></i> <strong>Best Practice:</strong> Start with a broad filter (Location or Type) to fetch a manageable subset of devices, then refine using Hostname or System Name for more specific results.
              </p>
            </div>
            {# Filters column #}
            <div class="col-md-8">
              <form method="get" class="form">
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="{{ filter_form.librenms_location.id_for_label }}" class="form-label">{{ filter_form.librenms_location.label }}</label>
                    {{ filter_form.librenms_location }}
                  </div>
                  <div class="col-md-6">
                    <label for="{{ filter_form.librenms_type.id_for_label }}" class="form-label">{{ filter_form.librenms_type.label }}</label>
                    {{ filter_form.librenms_type }}
                  </div>
                </div>
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="{{ filter_form.librenms_os.id_for_label }}" class="form-label">{{ filter_form.librenms_os.label }}</label>
                    {{ filter_form.librenms_os }}
                    {% if filter_form.librenms_os.help_text %}
                      <small class="form-text text-muted">{{ filter_form.librenms_os.help_text }}</small>
                    {% endif %}
                  </div>
                  <div class="col-md-6">
                    <label for="{{ filter_form.librenms_hostname.id_for_label }}" class="form-label">{{ filter_form.librenms_hostname.label }}</label>
                    {{ filter_form.librenms_hostname }}
                    {% if filter_form.librenms_hostname.help_text %}
                      <small class="form-text text-muted">{{ filter_form.librenms_hostname.help_text }}</small>
                    {% endif %}
                  </div>
                </div>
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="{{ filter_form.librenms_sysname.id_for_label }}" class="form-label">{{ filter_form.librenms_sysname.label }}</label>
                    {{ filter_form.librenms_sysname }}
                    {% if filter_form.librenms_sysname.help_text %}
                      <small class="form-text text-muted">{{ filter_form.librenms_sysname.help_text }}</small>
                    {% endif %}
                  </div>
                  <div class="col-md-6">
                    <label for="{{ filter_form.validation_status.id_for_label }}" class="form-label">{{ filter_form.validation_status.label }}</label>
                    {{ filter_form.validation_status }}
                    {% if filter_form.validation_status.help_text %}
                      <small class="form-text text-muted">{{ filter_form.validation_status.help_text }}</small>
                    {% endif %}
                  </div>
                </div>
                <div class="row mb-3">
                  <div class="col-md-12">
                    <div class="form-check">
                      {{ filter_form.show_disabled }}
                      <label class="form-check-label" for="{{ filter_form.show_disabled.id_for_label }}">
                        {{ filter_form.show_disabled.label }}
                      </label>
                      {% if filter_form.show_disabled.help_text %}
                        <small class="form-text text-muted d-block">{{ filter_form.show_disabled.help_text }}</small>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <div class="text-end">
                  <button type="submit" class="btn btn-primary">
                    <i class="mdi mdi-filter"></i> Apply Filters
                  </button>
                  <a href="{% url 'plugins:netbox_librenms_plugin:librenms_import' %}" class="btn btn-secondary">
                    <i class="mdi mdi-close"></i> Clear
                  </a>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  {# Applied filters #}
  {% if filter_form %}
    {% applied_filters model filter_form request.GET %}
  {% endif %}

  {# Results Section #}
  {% if table.page.paginator.count == 0 %}
    <div class="alert alert-warning mb-3">
        <h6 class="alert-heading">
            <i class="mdi mdi-alert"></i> No Results Found
        </h6>
        <p class="mb-0">
            No devices found matching your filters. Try adjusting your search criteria above.
        </p>
    </div>
  {% else %}
    {# Import Settings #}
    <div class="card mb-3 border-primary">
        <div class="card-body p-2">
            <div class="d-flex align-items-center gap-3">
                <strong class="me-2">Import Settings:</strong>
                <div class="form-check form-switch mb-0">
                    <input class="form-check-input" type="checkbox" id="use-sysname-toggle" checked
                           data-bs-toggle="tooltip"
                           title="Use SNMP sysName instead of LibreNMS hostname">
                    <label class="form-check-label small" for="use-sysname-toggle">
                        Use sysName
                    </label>
                </div>
                <div class="form-check form-switch mb-0">
                    <input class="form-check-input" type="checkbox" id="strip-domain-toggle"
                           data-bs-toggle="tooltip"
                           title="Remove domain suffix (e.g., 'switch01.example.com' â†’ 'switch01'). IP addresses preserved.">
                    <label class="form-check-label small" for="strip-domain-toggle">
                        Strip domain
                    </label>
                </div>
            </div>
        </div>
    </div>

    {# Bulk import toolbar #}
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
        <div class="d-flex align-items-center gap-2 flex-wrap">
            <button type="button" class="btn btn-outline-primary" id="select-all-ready">
                <i class="mdi mdi-checkbox-multiple-marked"></i> Select All Ready
            </button>
            <button type="button" class="btn btn-outline-secondary" id="select-none">
                <i class="mdi mdi-checkbox-multiple-blank-outline"></i> Deselect All
            </button>
            <span class="text-muted" id="selection-count">
                <i class="mdi mdi-information"></i> 0 devices selected
            </span>
        </div>
        <button type="button" class="btn btn-success" id="bulk-import-btn" disabled>
            <i class="mdi mdi-download"></i> Import Selected (<span id="import-count">0</span>)
        </button>
    </div>
  {% endif %}

  <form method="post" class="form form-horizontal">
    {% csrf_token %}
    <input type="hidden" name="return_url" value="{% if return_url %}{{ return_url }}{% else %}{{ request.path }}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}{% endif %}" />

    {# Objects table #}
    <div class="card">
      <div class="htmx-container" id="object_list"
           hx-trigger="deviceImported from:body"
           hx-get="{{ request.path }}?{{ request.GET.urlencode }}"
           hx-select="#object_list"
           hx-swap="outerHTML">
        {% include 'inc/paginator.html' with htmx=True table=table paginator=table.paginator page=table.page %}
        {% include 'inc/table.html' %}
        {% include 'inc/paginator.html' with htmx=True table=table paginator=table.paginator page=table.page %}
      </div>
    </div>
    {# /Objects table #}

  </form>

  {# Modal for bulk import results #}
  <div class="modal fade" id="import-results-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" id="import-results-modal-content">
                {# HTMX will populate this #}
            </div>
        </div>
    </div>

    {# Modal for import preview #}
    <div class="modal fade" id="import-preview-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" id="import-preview-content">
                {# HTMX will populate this #}
            </div>
        </div>
    </div>

    {# Modal for validation details #}
    <div class="modal fade" id="validation-detail-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" id="validation-detail-content">
                {# HTMX will populate this #}
            </div>
        </div>
    </div>

    {# Modal for import configuration #}
    <div class="modal fade" id="configure-import-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" id="configure-import-content">
                {# HTMX will populate this #}
            </div>
        </div>
    </div>

  {# Confirmation Modal for Import #}
  <div class="modal fade" id="import-confirm-modal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="mdi mdi-download"></i> Confirm Import
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="import-confirm-body">
          {# Action buttons #}
          <div class="d-flex gap-2 mb-3">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="mdi mdi-close"></i> Cancel
            </button>
            <button type="button" class="btn btn-success" id="confirm-import-btn">
              <span class="import-btn-content">
                <i class="mdi mdi-download"></i> Import
              </span>
              <span class="import-btn-spinner d-none">
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                Importing...
              </span>
            </button>
          </div>

          {# Device list section #}
          <div>
            <p class="fw-bold" id="import-confirm-message">Are you sure you want to import this device?</p>
            <div id="import-device-list"></div>
          </div>
        </div>
      </div>
        </div>
      </div>
    </div>
  </div>

  {# JavaScript for import functionality #}
  <script>
  // Configure HTMX to include CSRF token in all requests
  document.body.addEventListener('htmx:configRequest', function(event) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
      event.detail.headers['X-CSRFToken'] = csrfToken.value;
    }
  });

  document.addEventListener('DOMContentLoaded', function() {
    const modalElement = document.getElementById('htmx-modal');
    const modalContent = document.getElementById('htmx-modal-content');
    let fallbackBackdrop = null;

    // Helper function to check if a string is an IP address
    function isIPAddress(str) {
      try {
        // Simple regex check for IPv4
        const ipv4Regex = /^(\d{1,3}\.){3}\d{1,3}$/;
        if (ipv4Regex.test(str)) {
          const parts = str.split('.');
          return parts.every(part => parseInt(part) >= 0 && parseInt(part) <= 255);
        }
        // IPv6 contains colons
        return str.includes(':');
      } catch (e) {
        return false;
      }
    }

    // Helper function to process device name based on toggle states
    function processDeviceName(hostname, sysName, useSysName, stripDomain) {
      let name = useSysName ? (sysName || hostname) : hostname;

      if (stripDomain && name && name.includes('.') && !isIPAddress(name)) {
        name = name.split('.')[0];
      }

      return name;
    }

    // Initialize Bootstrap tooltips
    if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
      [...tooltipTriggerList].map(el => new bootstrap.Tooltip(el));
    }

    function showModal() {
      if (!modalElement) {
        return;
      }

      if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
        let instance = bootstrap.Modal.getInstance?.(modalElement) || null;
        if (!instance) {
          instance = new bootstrap.Modal(modalElement);
        }
        instance.show();
        return;
      }

      if (typeof window.bootstrap !== 'undefined' && window.bootstrap.Modal) {
        let instance = window.bootstrap.Modal.getInstance?.(modalElement) || null;
        if (!instance) {
          instance = new window.bootstrap.Modal(modalElement);
        }
        instance.show();
        return;
      }

      if (typeof $ !== 'undefined' && typeof $(modalElement).modal === 'function') {
        $(modalElement).modal('show');
        return;
      }

      if (!modalElement.classList.contains('show')) {
        modalElement.classList.add('show');
        modalElement.style.display = 'block';
        modalElement.removeAttribute('aria-hidden');
        modalElement.setAttribute('aria-modal', 'true');
      }

      if (!document.body.classList.contains('modal-open')) {
        document.body.classList.add('modal-open');
      }

      if (!document.querySelector('.modal-backdrop')) {
        fallbackBackdrop = document.createElement('div');
        fallbackBackdrop.className = 'modal-backdrop fade show';
        document.body.appendChild(fallbackBackdrop);
      }
    }

    function hideModal() {
      if (!modalElement) {
        return;
      }

      if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
        const instance = bootstrap.Modal.getInstance?.(modalElement);
        if (instance) {
          instance.hide();
          return;
        }
      }

      if (typeof window.bootstrap !== 'undefined' && window.bootstrap.Modal) {
        const instance = window.bootstrap.Modal.getInstance?.(modalElement);
        if (instance) {
          instance.hide();
          return;
        }
      }

      if (typeof $ !== 'undefined' && typeof $(modalElement).modal === 'function') {
        $(modalElement).modal('hide');
        return;
      }

      modalElement.classList.remove('show');
      modalElement.style.display = '';
      modalElement.setAttribute('aria-hidden', 'true');
      modalElement.removeAttribute('aria-modal');
      document.body.classList.remove('modal-open');

      if (fallbackBackdrop) {
        fallbackBackdrop.remove();
        fallbackBackdrop = null;
      } else {
        const backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) {
          backdrop.remove();
        }
      }
    }

    function ensureModalVisible(event) {
      if (!modalElement || event.detail.target.id !== 'htmx-modal-content') {
        return;
      }

      if (modalContent && modalContent.innerHTML.trim().length === 0 && event.detail.xhr) {
        modalContent.innerHTML = event.detail.xhr.responseText;
      }

      showModal();
    }

    document.body.addEventListener('htmx:afterSwap', ensureModalVisible);

    document.body.addEventListener('click', function(event) {
      if (!modalElement) {
        return;
      }

      const dismissTrigger = event.target.closest('[data-bs-dismiss="modal"]');
      if (dismissTrigger) {
        event.preventDefault();

        // Check if it's in the HTMX modal
        if (modalElement.contains(dismissTrigger)) {
          hideModal();
        }

        // Check if it's in the confirmation modal
        const confirmModal = document.getElementById('import-confirm-modal');
        if (confirmModal && confirmModal.contains(dismissTrigger)) {
          if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
            const modalInstance = bootstrap.Modal.getInstance(confirmModal);
            if (modalInstance) {
              modalInstance.hide();
            }
          } else if (typeof $ !== 'undefined' && $.fn.modal) {
            $(confirmModal).modal('hide');
          } else {
            confirmModal.classList.remove('show', 'd-block');
            confirmModal.style.display = '';
            confirmModal.setAttribute('aria-hidden', 'true');
            confirmModal.removeAttribute('aria-modal');

            const backdrop = document.getElementById('import-confirm-backdrop');
            if (backdrop) {
              backdrop.remove();
            }
            document.body.classList.remove('modal-open');
          }
        }
      }
    });

    // Handle backdrop clicks for HTMX modal
    modalElement?.addEventListener('click', function(event) {
      if (event.target === modalElement) {
        hideModal();
      }
    });

    // Handle backdrop clicks for confirmation modal
    const confirmModalElement = document.getElementById('import-confirm-modal');
    confirmModalElement?.addEventListener('click', function(event) {
      if (event.target === confirmModalElement) {
        if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
          const modalInstance = bootstrap.Modal.getInstance(confirmModalElement);
          if (modalInstance) {
            modalInstance.hide();
          }
        } else if (typeof $ !== 'undefined' && $.fn.modal) {
          $(confirmModalElement).modal('hide');
        } else {
          confirmModalElement.classList.remove('show', 'd-block');
          confirmModalElement.style.display = '';
          confirmModalElement.setAttribute('aria-hidden', 'true');
          confirmModalElement.removeAttribute('aria-modal');

          const backdrop = document.getElementById('import-confirm-backdrop');
          if (backdrop) {
            backdrop.remove();
          }
          document.body.classList.remove('modal-open');
        }
      }
    });

    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        if (modalElement?.classList.contains('show')) {
          hideModal();
        }
        if (confirmModalElement?.classList.contains('show')) {
          if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
            const modalInstance = bootstrap.Modal.getInstance(confirmModalElement);
            if (modalInstance) {
              modalInstance.hide();
            }
          } else if (typeof $ !== 'undefined' && $.fn.modal) {
            $(confirmModalElement).modal('hide');
          } else {
            confirmModalElement.classList.remove('show', 'd-block');
            confirmModalElement.style.display = '';
            confirmModalElement.setAttribute('aria-hidden', 'true');
            confirmModalElement.removeAttribute('aria-modal');

            const backdrop = document.getElementById('import-confirm-backdrop');
            if (backdrop) {
              backdrop.remove();
            }
            document.body.classList.remove('modal-open');
          }
        }
      }
    });

    const bulkImportBtn = document.getElementById('bulk-import-btn');
    const selectionCount = document.getElementById('selection-count');
    const importCount = document.getElementById('import-count');

    function getCheckboxes() {
      return document.querySelectorAll('input[name="select"]');
    }

    function updateSelectionDisplay() {
      if (!bulkImportBtn || !selectionCount || !importCount) {
        return;
      }

      const checkboxes = getCheckboxes();
      const selected = Array.from(checkboxes).filter(cb => cb.checked);
      const count = selected.length;

      selectionCount.innerHTML = `<i class="mdi mdi-information"></i> ${count} device${count !== 1 ? 's' : ''} selected`;
      importCount.textContent = count;
      bulkImportBtn.disabled = count === 0;
    }

    updateSelectionDisplay();

    const selectAllReadyBtn = document.getElementById('select-all-ready');
    if (selectAllReadyBtn) {
      selectAllReadyBtn.addEventListener('click', function() {
        const checkboxes = getCheckboxes();
        checkboxes.forEach(cb => {
          // Select checkboxes for rows that have a ready-to-import button (device-ready class)
          if (!cb.disabled && cb.closest('tr')?.querySelector('.device-ready')) {
            cb.checked = true;
          }
        });
        updateSelectionDisplay();
      });
    }

    const selectNoneBtn = document.getElementById('select-none');
    if (selectNoneBtn) {
      selectNoneBtn.addEventListener('click', function() {
        const checkboxes = getCheckboxes();
        checkboxes.forEach(cb => {
          cb.checked = false;
        });
        updateSelectionDisplay();
      });
    }

    // Use event delegation for checkbox changes since they can be dynamically added
    document.body.addEventListener('change', function(event) {
      if (event.target.matches('input[name="select"]')) {
        updateSelectionDisplay();
      }
    });

    // Bulk import button handler
    if (bulkImportBtn) {
      bulkImportBtn.addEventListener('click', function() {
        const selectedCheckboxes = Array.from(getCheckboxes()).filter(cb => cb.checked);

        if (selectedCheckboxes.length === 0) {
          return;
        }

        // Collect device info for confirmation modal
        const deviceInfoList = selectedCheckboxes.map(cb => {
          const row = cb.closest('tr');
          const deviceId = cb.value;

          // Get hostname and sysName from data attributes
          const hostname = cb.dataset.hostname || 'Unknown';
          const sysName = cb.dataset.sysname || hostname;

          let roleText = null;
          let roleId = null;

          if (row) {
            const roleSelect = row.querySelector('select[name^="role_"]');
            if (roleSelect && roleSelect.value) {
              roleId = roleSelect.value;
              roleText = roleSelect.options[roleSelect.selectedIndex].text;
            }
          }

          return { id: deviceId, hostname, sysName, roleText, roleId };
        });

        // Store for confirmation
        pendingImportData = {
          url: '{% url "plugins:netbox_librenms_plugin:bulk_import_devices" %}',
          isBulk: true,
          devices: deviceInfoList
        };

        // Update modal content for bulk import
        const confirmMessage = document.getElementById('import-confirm-message');
        confirmMessage.textContent = `Are you sure you want to import ${deviceInfoList.length} device${deviceInfoList.length > 1 ? 's' : ''}?`;

        // Get toggle values and render device list
        const useSysName = document.getElementById('use-sysname-toggle').checked;
        const stripDomain = document.getElementById('strip-domain-toggle').checked;

        const deviceListHTML = deviceInfoList.map(dev => {
          const displayName = processDeviceName(dev.hostname, dev.sysName, useSysName, stripDomain);
          return `
            <div class="alert alert-info mb-2">
              <div><strong><i class="mdi mdi-server"></i> ${displayName}</strong></div>
              ${dev.roleText ? `<small class="text-muted">Role: ${dev.roleText}</small>` : ''}
            </div>
          `;
        }).join('');

        deviceList.innerHTML = deviceListHTML;

        // Show the confirmation modal
        if (confirmModal) {
          if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
            const modalInstance = bootstrap.Modal.getOrCreateInstance(confirmModal);
            modalInstance.show();
          } else if (typeof $ !== 'undefined' && $.fn.modal) {
            $(confirmModal).modal('show');
          } else {
            confirmModal.classList.add('show', 'd-block');
            confirmModal.style.display = 'block';
            confirmModal.setAttribute('aria-modal', 'true');
            confirmModal.removeAttribute('aria-hidden');

            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop fade show';
            backdrop.id = 'import-confirm-backdrop';
            document.body.appendChild(backdrop);
            document.body.classList.add('modal-open');
          }
        }
      });
    }

    document.body.addEventListener('htmx:afterSwap', function(event) {
      if (event.detail.target.tagName === 'TR') {
        updateSelectionDisplay();
      }

      if (event.detail.target.id === 'import-results-modal-content') {
        const failedCount = event.detail.target.querySelector('[data-failed-count]');
        if (failedCount && failedCount.dataset.failedCount === '0') {
          setTimeout(() => {
            const resultsModal = document.getElementById('import-results-modal');
            if (resultsModal && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
              const modalInstance = bootstrap.Modal.getInstance(resultsModal);
              if (modalInstance) {
                modalInstance.hide();
              }
            }
            window.location.reload();
          }, 3000);
        }
      }
    });

    const currentUrl = window.location.href;
    const lastUrl = sessionStorage.getItem('last_import_url');

    if (currentUrl !== lastUrl) {
      Object.keys(sessionStorage).forEach(key => {
        if (key.startsWith('device_role_')) {
          sessionStorage.removeItem(key);
        }
      });
    }

    sessionStorage.setItem('last_import_url', currentUrl);

    // Import confirmation modal handling
    const confirmModal = document.getElementById('import-confirm-modal');
    const confirmBtn = document.getElementById('confirm-import-btn');
    const confirmBody = document.getElementById('import-confirm-body');
    const deviceList = document.getElementById('import-device-list');
    let pendingImportData = null;

    document.body.addEventListener('click', function(event) {
      const importBtn = event.target.closest('.device-import-btn');

      if (!importBtn) {
        return;
      }

      if (importBtn.disabled) {
        return;
      }

      event.preventDefault();
      event.stopPropagation();

      const deviceId = importBtn.dataset.deviceId;
      const importUrl = importBtn.dataset.importUrl;

      // Try multiple selectors to find the hostname
      let hostname = 'this device';
      const row = importBtn.closest('tr');
      if (row) {
        const hostnameCell = row.querySelector('td:nth-child(2)');
        if (hostnameCell) {
          const strongTag = hostnameCell.querySelector('strong');
          hostname = strongTag ? strongTag.textContent.trim() : hostnameCell.textContent.trim();
        }
      }

      const roleSelect = document.querySelector(`[name="role_${deviceId}"]`);
      const clusterSelect = document.querySelector(`[name="cluster_${deviceId}"]`);

      // Determine if importing as VM based on cluster selection
      const isVM = clusterSelect && clusterSelect.value;

      // Store the import data for confirmation
      pendingImportData = {
        url: importUrl,
        deviceId: deviceId,
        hostname: hostname,
        sysName: hostname, // For now use hostname as sysName (backend will use correct value)
        roleId: roleSelect ? roleSelect.value : null,
        roleText: roleSelect && roleSelect.value ? roleSelect.options[roleSelect.selectedIndex].text : null,
        clusterId: clusterSelect ? clusterSelect.value : null,
        clusterText: clusterSelect && clusterSelect.value ? clusterSelect.options[clusterSelect.selectedIndex].text : null,
        isVM: isVM
      };

      // Update modal content
      const confirmMessage = document.getElementById('import-confirm-message');
      confirmMessage.textContent = `Are you sure you want to import the following ${isVM ? 'Virtual Machine' : 'Device'}?`;

      // Get toggle values and render device
      const useSysName = document.getElementById('use-sysname-toggle').checked;
      const stripDomain = document.getElementById('strip-domain-toggle').checked;
      const displayName = processDeviceName(pendingImportData.hostname, pendingImportData.sysName, useSysName, stripDomain);

      let typeIcon = isVM ? 'mdi-cloud' : 'mdi-server';
      let typeLabel = isVM ? 'Virtual Machine' : 'Device';
      let typeBadge = isVM ? 'bg-info' : 'bg-primary';

      deviceList.innerHTML = `
        <div class="alert alert-info mb-0">
          <div><strong><i class="mdi ${typeIcon}"></i> ${displayName}</strong> <span class="badge ${typeBadge} ms-2">${typeLabel}</span></div>
          ${pendingImportData.clusterText ? `<small class="text-muted">Cluster: ${pendingImportData.clusterText}</small><br>` : ''}
          ${pendingImportData.roleText ? `<small class="text-muted">Role: ${pendingImportData.roleText}</small>` : ''}
        </div>
      `;

      // Show the confirmation modal using Bootstrap or Tabler
      if (confirmModal) {
        if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
          const modalInstance = bootstrap.Modal.getOrCreateInstance(confirmModal);
          modalInstance.show();
        } else if (typeof $ !== 'undefined' && $.fn.modal) {
          $(confirmModal).modal('show');
        } else {
          // Fallback manual show
          confirmModal.classList.add('show', 'd-block');
          confirmModal.style.display = 'block';
          confirmModal.setAttribute('aria-modal', 'true');
          confirmModal.removeAttribute('aria-hidden');

          const backdrop = document.createElement('div');
          backdrop.className = 'modal-backdrop fade show';
          backdrop.id = 'import-confirm-backdrop';
          document.body.appendChild(backdrop);
          document.body.classList.add('modal-open');
        }
      }
    });

    confirmBtn.addEventListener('click', function() {
      if (!pendingImportData) {
        return;
      }

      // Show spinner and disable button
      const btnContent = confirmBtn.querySelector('.import-btn-content');
      const btnSpinner = confirmBtn.querySelector('.import-btn-spinner');
      btnContent.classList.add('d-none');
      btnSpinner.classList.remove('d-none');
      confirmBtn.disabled = true;

      // Prepare form data
      const formData = new FormData();

      // Get the name options toggle values
      const useSysName = document.getElementById('use-sysname-toggle').checked;
      const stripDomain = document.getElementById('strip-domain-toggle').checked;
      formData.append('use_sysname', useSysName ? 'true' : 'false');
      formData.append('strip_domain', stripDomain ? 'true' : 'false');

      if (pendingImportData.isBulk) {
        // Bulk import - add all device IDs and their roles
        pendingImportData.devices.forEach(dev => {
          formData.append('select', dev.id);
          if (dev.roleId) {
            formData.append(`role_${dev.id}`, dev.roleId);
          }
          if (dev.clusterId) {
            formData.append(`cluster_${dev.id}`, dev.clusterId);
          }
        });
      } else {
        // Single import - add role and cluster if present
        if (pendingImportData.roleId) {
          formData.append(`role_${pendingImportData.deviceId}`, pendingImportData.roleId);
        }
        if (pendingImportData.clusterId) {
          formData.append(`cluster_${pendingImportData.deviceId}`, pendingImportData.clusterId);
        }
      }

      // Execute the import
      fetch(pendingImportData.url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
          'HX-Request': 'true'
        },
        body: formData
      })
      .then(response => {
        // Get response text first to handle both success and error cases
        return response.text().then(text => {
          return { ok: response.ok, status: response.status, text: text };
        });
      })
      .then(result => {
        if (result.ok) {
          // Close modal
          if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
            const modalInstance = bootstrap.Modal.getInstance(confirmModal);
            if (modalInstance) {
              modalInstance.hide();
            }
          } else if (typeof $ !== 'undefined' && $.fn.modal) {
            $(confirmModal).modal('hide');
          } else {
            // Fallback manual hide
            confirmModal.classList.remove('show', 'd-block');
            confirmModal.style.display = '';
            confirmModal.setAttribute('aria-hidden', 'true');
            confirmModal.removeAttribute('aria-modal');

            const backdrop = document.getElementById('import-confirm-backdrop');
            if (backdrop) {
              backdrop.remove();
            }
            document.body.classList.remove('modal-open');
          }

          // For bulk imports, reload the page to show results
          // For single imports, trigger table refresh
          if (pendingImportData.isBulk) {
            window.location.reload();
          } else {
            // Trigger table refresh for single device import
            document.body.dispatchEvent(new CustomEvent('deviceImported'));

            // Show success message for single device
            const messages = document.createElement('div');
            messages.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
            messages.style.zIndex = '9999';

            messages.innerHTML = `
              <i class="mdi mdi-check-circle"></i> Successfully imported ${pendingImportData.hostname}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(messages);
            setTimeout(() => messages.remove(), 5000);
          }
        } else {
          throw new Error(`Import failed: ${result.status}`);
        }
      })
      .catch(error => {
        // Hide spinner and re-enable button on error
        const btnContent = confirmBtn.querySelector('.import-btn-content');
        const btnSpinner = confirmBtn.querySelector('.import-btn-spinner');
        btnSpinner.classList.add('d-none');
        btnContent.classList.remove('d-none');
        confirmBtn.disabled = false;

        const messages = document.createElement('div');
        messages.className = 'alert alert-danger alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
        messages.style.zIndex = '9999';

        const errorMsg = pendingImportData.isBulk
          ? `Failed to import ${pendingImportData.devices.length} device${pendingImportData.devices.length > 1 ? 's' : ''}`
          : `Failed to import ${pendingImportData.hostname}`;

        messages.innerHTML = `
          <i class="mdi mdi-alert-circle"></i> ${errorMsg}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(messages);
        setTimeout(() => messages.remove(), 5000);
      })
      .finally(() => {
        // Reset button state
        const btnContent = confirmBtn.querySelector('.import-btn-content');
        const btnSpinner = confirmBtn.querySelector('.import-btn-spinner');
        btnSpinner.classList.add('d-none');
        btnContent.classList.remove('d-none');
        confirmBtn.disabled = false;

        pendingImportData = null;
      });
    });
  });
  </script>

    {# HTMX Modal for import actions #}
  <div class="modal fade" id="htmx-modal" tabindex="-1" aria-labelledby="htmxModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content" id="htmx-modal-content">
        {# Content loaded via HTMX #}
        <div class="modal-body text-center">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </div>
    </div>
  </div>

{% endblock %}

